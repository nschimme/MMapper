name: build-wasm

on:
  push:
    tags:
    - 'v*'
    branches:
    - master
  pull_request:
  workflow_dispatch:

jobs:
  build-wasm:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
        submodules: true

    - name: ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        create-symlink: true
        key: ${{ github.job }}

    - name: Install Qt for Wasm
      uses: jurplel/install-qt-action@v4
      with:
        version: 6.5.3
        host: mac
        arch: wasm_multithread
        cache: true
        modules: 'qtwebsockets'

    - name: Setup emsdk
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 3.1.25

    - name: Configure and Build
      shell: bash
      run: |
        $QT_ROOT_DIR/bin/qt-cmake -S . -B build \
          -DQT_HOST_PATH=$QT_HOST_PATH \
          -DWITH_OPENSSL=OFF \
          -DWITH_TESTS=OFF \
          -DWITH_WEBSOCKET=ON \
          -DWITH_UPDATER=OFF \
          -DCMAKE_BUILD_TYPE=Release \
          -DPACKAGE_TYPE=Wasm \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        cmake --build build

    - name: Get Git tag description
      id: git_info
      run: |
        git config --global --add safe.directory $(pwd)
        VERSION=$(git tag --points-at HEAD | grep -v '^beta$' | sed 's/^v//' | head -n 1 || true)
        VERSION=${VERSION:-$(git describe --tags --always --long --exclude beta | sed 's/^v//' || true)}
        VERSION=${VERSION:-$(cat MMAPPER_VERSION)}
        FILE="mmapper-${VERSION}-wasm.zip"
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "FILE=${FILE}" >> $GITHUB_OUTPUT

    - name: Install and Package
      run: |
        cmake --install build
        # The zip is created by the install(CODE) block in src/CMakeLists.txt
        # and its name should match or be close to the one expected here.
        mv build/mmapper-*-wasm.zip ./${{ steps.git_info.outputs.FILE }}

    - name: Upload Package
      uses: actions/upload-artifact@v6
      with:
        name: mmapper-${{ steps.git_info.outputs.VERSION }}-wasm
        path: ${{ steps.git_info.outputs.FILE }}
